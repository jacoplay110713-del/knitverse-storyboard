<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Knitverse · Hybrid Storyboard v4.0</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0b0c10; --panel:#10151b; --card:#141c26; --text:#eaf2ff; --muted:#a9b7c6; --blue:#35d0ff; --gold:#ffd54f; --line:#223244; }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 80% -10%, #16212c 0%, var(--bg) 55%);color:var(--text);
       font:14px/1.6 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  header{position:sticky;top:0;z-index:20;background:rgba(10,14,20,.85);backdrop-filter:blur(8px);border-bottom:1px solid #162433;
         display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px}
  .brand{font-family:'Orbitron';letter-spacing:.14em;color:#35d0ff;font-weight:800;text-transform:uppercase;text-shadow:0 0 10px #35d0ff77}
  .wrap{display:grid;grid-template-columns:400px 1fr;gap:14px;padding:14px}
  @media(max-width:1240px){.wrap{grid-template-columns:1fr}}
  aside{background:var(--panel);border:1px solid #1b2a3a;border-radius:14px;padding:12px}
  .section-title{margin:6px 0 8px;font-weight:800;color:#d6e6ff}
  .flow-list{display:grid;gap:8px}
  .flow{background:linear-gradient(180deg,#0f141b,#0f1822);border:1px solid #203044;border-radius:12px;padding:10px;cursor:grab;position:relative}
  .flow.active{border-color:var(--gold);box-shadow:0 0 0 2px #ffd54f33}
  .flow.drag-over{outline:2px dashed #35d0ff}
  .flow .reord{position:absolute;top:8px;right:8px;font-size:10px;color:#96b}
  .meta{color:#9eb0c6;font-size:12px}
  .picker{display:grid;gap:8px;background:#0f141b;border:1px solid #203044;border-radius:12px;padding:10px;margin-top:10px}
  input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #223244;background:#0b1219;color:#eaf2ff}
  .radio{display:flex;gap:12px;align-items:center;margin:6px 0 2px}
  .small{font-size:12px;color:#9fb0c6}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin-top:8px}
  .thumb{border:1px solid var(--line);border-radius:10px;padding:6px;background:#0b1219;text-align:center;position:relative}
  .thumb[draggable="true"]{cursor:grab}
  .thumb.drag-over{outline:2px dashed #35d0ff}
  .thumb img{max-width:100%;max-height:68px;border-radius:6px;display:block;margin:0 auto 6px}
  .thumb .cap{font-size:11px;color:#cfe2ff}
  .thumb .del{position:absolute;top:6px;right:6px;background:#150e0e;border:1px solid #4a2020;color:#ff9b9b;border-radius:8px;font-size:11px;padding:2px 6px;cursor:pointer}
  main{background:var(--panel);border:1px solid #1b2a3a;border-radius:14px;padding:0;overflow:hidden}
  .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px;border-bottom:1px solid #192737}
  .crumbs{color:#b9c7d8;font-size:12px}
  .btn{background:#0f141b;border:1px solid #223244;color:#eaf2ff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{border-color:var(--gold);color:#111;background:var(--gold);font-weight:800}
  .stage{padding:14px}
  .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .tab{background:#0f141b;border:1px solid #223244;color:#cfe2ff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .tab.active{border-color:var(--gold);color:var(--gold)}
  .screen{position:relative;background:linear-gradient(180deg,#0f141b,#101a24);border:1px solid #223244;border-radius:12px;padding:14px;min-height:480px;box-shadow:0 14px 44px #0008}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .card{position:relative;background:#141c26;border:1px solid #223244;border-radius:12px;padding:12px}
  .progress{height:8px;background:#0c1219;border:1px solid #1e2b3a;border-radius:999px;overflow:hidden;margin:8px 0 0}
  .bar{height:100%;background:linear-gradient(90deg,#35d0ff,#ffd54f);width:0%}
  .liveWrap{display:grid;grid-template-columns:1fr;gap:10px}
  .splitWrap{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  iframe{width:100%;height:540px;border:1px solid #223244;border-radius:12px;background:#0b0c10}
  .imgStageWrap{background:linear-gradient(180deg,#0f141b,#0f1721);border:1px solid #203044;border-radius:12px;padding:10px}
  .imgBoard{position:relative;display:flex;align-items:center;justify-content:center;min-height:540px;background:#0b0c10;border:1px dashed #234;border-radius:12px;overflow:hidden}
  .imgBoard img{max-width:100%;max-height:520px;border-radius:8px;display:block}
  .pinLayer{position:absolute;inset:0;pointer-events:none}
  .pin{position:absolute;transform:translate(-50%,-50%);background:#ffd54f;color:#111;border:2px solid #111;border-radius:999px;width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;pointer-events:auto;cursor:pointer}
  .pin:hover{box-shadow:0 0 0 4px #ffd54f33}
  .pinNote{position:absolute;transform:translate(8px,-50%);background:#141c26;color:#eaf2ff;border:1px solid #223244;border-radius:8px;padding:6px;min-width:160px;max-width:260px;font-size:12px}
  .imgTools{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
  .hint{font-size:12px;color:#9fb0c6}
  .structTools{position:absolute;top:8px;right:8px;display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<header>
  <div class="brand">KNITVERSE · Hybrid Storyboard v4.0</div>
</header>
<div class="wrap">
  <aside>
    <div class="section-title">플로우 선택 (드래그로 순서 변경)</div>
    <div class="flow-list" id="flowList"></div>

    <div class="section-title" style="margin-top:16px">Live Demo 소스</div>
    <div class="picker">
      <div class="radio">
        <label><input type="radio" name="source" value="iframe" checked> Iframe (HTML)</label>
        <label><input type="radio" name="source" value="images"> Step Images (단계별 이미지)</label>
      </div>
      <div id="srcIframeBox">
        <label>파일 경로/이름 입력</label>
        <input id="srcText" type="text" placeholder="예: knitverse_mvp_skin_pro.html 또는 ./sub/app.html">
        <button class="btn" id="applySrc">적용</button>
        <div class="small">또는 파일 선택 →</div>
        <input id="srcFile" type="file" accept=".html,.htm">
        <div class="small" id="srcStatus">현재: 연결되지 않음</div>
      </div>
      <div id="srcImagesBox" style="display:none">
        <div class="small">이미지를 여러 번 나눠 올려도 됩니다. <b>현재 단계부터</b> 순서대로 매핑됩니다.</div>
        <div class="imgTools">
          <button class="btn" id="btnPickImages">이미지 선택</button>
          <button class="btn" id="btnAssignFromCurrent">현재 단계부터 재할당</button>
          <button class="btn" id="btnClearMap">이 플로우 매핑 초기화</button>
        </div>
        <input id="imgFiles" type="file" accept="image/*" multiple style="display:none">
        <div class="small" id="imgInfo">아직 매핑된 이미지가 없습니다.</div>
        <div class="thumbs" id="imgList"></div>
      </div>
    </div>
  </aside>
  <main>
    <div class="toolbar">
      <div class="crumbs" id="crumbs">HOME</div>
      <div class="controls">
        <button class="btn" id="btnPrev">← 이전</button>
        <button class="btn primary" id="btnNext">다음 →</button>
      </div>
    </div>

    <div class="stage">
      <div class="tabs">
        <button class="tab active" data-panel="struct">Structure</button>
        <button class="tab" data-panel="live">Live</button>
        <button class="tab" data-panel="split">Split (이미지+라이브)</button>
      </div>

      <div id="structPanel" class="screen">
        <div class="structTools">
          <label class="small"><input type="checkbox" id="structPinMode"> 메모 모드</label>
          <button class="btn" id="btnStructClearPins">이 단계 메모 삭제</button>
          <!-- v4: 단계 편집 버튼 -->
          <button class="btn" id="btnStepAdd">단계 추가</button>
          <button class="btn" id="btnStepRename">이름 변경</button>
          <button class="btn" id="btnStepDelete">단계 삭제</button>
        </div>
        <div id="structBody"></div>
        <div class="pinLayer" id="structPinLayer"></div>
      </div>
      <div id="livePanel" class="liveWrap" style="display:none">
        <!-- Images mode -->
        <div id="imagesPane" class="imgStageWrap" style="display:none">
          <div class="imgTools">
            <label><input type="checkbox" id="pinMode"> 핀 추가 모드</label>
            <button class="btn" id="btnClearPins">이 단계 핀 삭제</button>
            <span class="hint">핀 추가 모드에서 이미지 위를 클릭하면 핀과 설명을 추가할 수 있어요.</span>
          </div>
          <div class="imgBoard" id="imgBoard">
            <img id="stepImg" alt="Step image">
            <div class="pinLayer" id="pinLayer"></div>
          </div>
        </div>
        <!-- Iframe mode -->
        <div id="iframePane" class="imgStageWrap" style="display:none">
          <iframe id="liveFrame"></iframe>
          <div class="hint">해시 내비(#home/#shop/#classes/#mypage)로 스텝 이동에 맞춰 연동합니다.</div>
        </div>
      </div>
      <div id="splitPanel" class="splitWrap" style="display:none">
        <div class="imgStageWrap">
          <div class="imgBoard">
            <img id="splitImg" alt="Step image">
            <div class="pinLayer" id="splitPinLayer"></div>
          </div>
        </div>
        <div class="imgStageWrap">
          <iframe id="splitFrame"></iframe>
          <div class="hint">좌: 이미지, 우: 라이브. 스텝 이동 시 양쪽 동기화.</div>
        </div>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>
    <footer id="footer"></footer>
  </main>
</div>
<script>
/* =========================
   플로우 정의 (5개)
========================= */
const BASE_FLOWS=[
 {key:'fan',     title:'팬 · 구매 플로우', map:['home','shop','product','checkout','done'], steps:[
   {title:'HOME',body:'히어로 배너에서 상품 진입'},
   {title:'SHOP',body:'트렌딩 상품 리스트'},
   {title:'상세',body:'상품 상세 페이지'},
   {title:'체크아웃',body:'결제 요약 화면'},
   {title:'완료',body:'주문 완료'}]},
 {key:'rookie',  title:'루키 · 성장 플로우', map:['home','apply','klgc','upload','publish'], steps:[
   {title:'HOME',body:'APPLY 클릭'},
   {title:'Apply Form',body:'아티스트 지원 폼'},
   {title:'K-LGC',body:'4주 커리큘럼 단계'},
   {title:'Upload',body:'상품 업로드'},
   {title:'Publish',body:'상품 공개 완료'}]},
 {key:'learner', title:'학습자 · 클래스 플로우', map:['home','classes','detail','enroll','play'], steps:[
   {title:'HOME',body:'클래스 탭 클릭'},
   {title:'Class List',body:'강의 목록'},
   {title:'Detail',body:'강의 상세 설명'},
   {title:'Enroll',body:'수강 등록'},
   {title:'Player',body:'강의 재생'}]},
 {key:'creator', title:'액티브/마스터 작가 플로우', map:['home','classes','create','sell','legacy'], steps:[
   {title:'HOME',body:'MY PAGE에서 크리에이터 허브 진입'},
   {title:'클래스 개설',body:'커리큘럼/가격/언어 설정'},
   {title:'상품화',body:'키트/도안 번들 구성 · 재고'},
   {title:'판매/프로모션',body:'런칭 · 팬/커뮤니티 프로모션'},
   {title:'레거시 축적',body:'멘토링/평가 · 레거시 스코어 상승'}]},
 {key:'support', title:'서포터즈 플로우', map:['home','community','apply','board','credit'], steps:[
   {title:'HOME',body:'COMMUNITY 진입'},
   {title:'Supporter Hub',body:'역할 선택/가용성 설정'},
   {title:'Apply',body:'프로필 제출'},
   {title:'Matching Board',body:'프로젝트 매칭/승인'},
   {title:'크레딧 & 보상',body:'K-Points 적립/정산'}]}
];
/* =========================
   상태 & 저장 키 + 헬퍼
========================= */
let flows = [];
let currentFlowIdx = 0;
let currentStep = 0;

const STORAGE = {
  ORDER: 'kv_v33_flow_order',
  SRC:   'kv_v33_src',
  MODE:  'kv_v33_mode',
  IMGS:  'kv_v33_images',
  PINS:  'kv_v33_pins',
  SPINS: 'kv_v33_struct_pins',
  // v4 추가
  FLOWS: 'kv_v40_flows',   // 편집된 플로우 구조
  STATE: 'kv_v40_state'    // 마지막 위치(탭/플로우/단계)
};

function getLS(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch(e){ return def; } }
function setLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function $(id){ return document.getElementById(id); }
function uuid(){ return Math.random().toString(36).slice(2,10); }
function activeFlow(){ return flows[currentFlowIdx]; }
function flowLen(){ return activeFlow().steps.length; }

function saveFlowsToLS(flowsArr){ localStorage.setItem(STORAGE.FLOWS, JSON.stringify(flowsArr)); }
function loadFlowsFromLS(){ try{ return JSON.parse(localStorage.getItem(STORAGE.FLOWS) || 'null'); }catch(e){ return null; } }
/* =========================
   초기화 (플로우 순서 복원 & 병합)
========================= */
function initFlows(){
  const saved = loadFlowsFromLS();
  if(saved && Array.isArray(saved) && saved.length){
    flows = saved;
  }else{
    const order = getLS(STORAGE.ORDER, BASE_FLOWS.map(f=>f.key));
    const byKey = Object.fromEntries(BASE_FLOWS.map(f=>[f.key, f]));
    flows = order.map(k => byKey[k]).filter(Boolean);
    BASE_FLOWS.forEach(f=>{ if(!flows.find(x=>x.key===f.key)) flows.push(f); });
    setLS(STORAGE.ORDER, flows.map(f=>f.key));
    saveFlowsToLS(flows);
  }
}

/* =========================
   세션 상태 저장/복원
========================= */
function saveState(){
  const activeTab = document.querySelector('.tab.active')?.dataset.panel || 'struct';
  setLS(STORAGE.STATE, { flowIdx: currentFlowIdx, stepIdx: currentStep, tab: activeTab });
}
function loadState(){
  const s = getLS(STORAGE.STATE, null);
  if(!s) return;
  currentFlowIdx = Math.min(Math.max(0, s.flowIdx||0), flows.length-1);
  currentStep    = Math.min(Math.max(0, s.stepIdx||0), flowLen()-1);
  switchToTab(s.tab || 'struct');
}

/* =========================
   Structure: 핀/메모
========================= */
function structPins(flowKey=activeFlow().key, step=currentStep){
  const o = getLS(STORAGE.SPINS, {});
  if(!o[flowKey]) o[flowKey]={};
  if(!o[flowKey][step]) o[flowKey][step]=[];
  setLS(STORAGE.SPINS, o);
  return o[flowKey][step];
}
function setStructPins(list, flowKey=activeFlow().key, step=currentStep){
  const o = getLS(STORAGE.SPINS, {});
  if(!o[flowKey]) o[flowKey]={};
  o[flowKey][step]=list;
  setLS(STORAGE.SPINS, o);
}
function renderStructure(){
  const f=activeFlow(), s=f.steps[currentStep];
  $('structBody').innerHTML = `
    <h2>${s.title}</h2>
    <p class="meta">${s.body||''}</p>
    <div class="grid">
      <div class="card" data-slot="core"><strong>핵심 요소</strong><div class="meta">CTA · 사용자 목표 · 성공 시그널</div></div>
      <div class="card" data-slot="link"><strong>연결</strong><div class="meta">다음 화면으로 넘어가는 트리거</div></div>
      <div class="card" data-slot="metric"><strong>메트릭</strong><div class="meta">전환/이탈 포인트, GA 이벤트</div></div>
    </div>`;
  $('crumbs').innerText = f.title + ' › ' + s.title;
  $('bar').style.width = ((currentStep+1)/flowLen()*100)+'%';
  $('footer').innerText = `${f.title} · Step ${currentStep+1}/${flowLen()}`;
  $('btnPrev').disabled = currentStep===0;
  $('btnNext').disabled = currentStep===flowLen()-1;
  renderStructPinLayer();
}

let structPinMode=false;
$('structPinMode').addEventListener('change', e=>{ structPinMode = e.target.checked; });
$('btnStructClearPins').addEventListener('click', ()=>{ setStructPins([]); renderStructPinLayer(); });

function renderStructPinLayer(){
  const layer = $('structPinLayer'); layer.innerHTML='';
  const list = structPins();
  list.forEach((p,idx)=>{
    const pin = document.createElement('div');
    pin.className='pin'; pin.innerText=String(idx+1);
    pin.style.left=p.x+'%'; pin.style.top=p.y+'%';
    const note=document.createElement('div');
    note.className='pinNote'; note.textContent=p.text||'(메모 없음)'; note.style.display='none';
    pin.addEventListener('mouseenter', ()=>{ note.style.display='block'; });
    pin.addEventListener('mouseleave', ()=>{ note.style.display='none'; });
    pin.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const v = prompt('메모 수정 (비우면 삭제)', p.text||'');
      if(v===null) return;
      const arr=list.slice();
      if(v.trim()===''){ setStructPins(arr.filter(x=>x.id!==p.id)); }
      else { p.text=v.trim(); setStructPins(arr); }
      renderStructPinLayer();
    });
    const wrap=document.createElement('div');
    wrap.style.position='absolute'; wrap.style.left=p.x+'%'; wrap.style.top=p.y+'%'; wrap.style.transform='translate(-50%,-50%)';
    wrap.appendChild(pin); wrap.appendChild(note);
    layer.appendChild(wrap);
  });
}
$('structPanel').addEventListener('click', (e)=>{
  if(!structPinMode) return;
  if(e.target.closest('.structTools')) return;
  const rect = $('structPanel').getBoundingClientRect();
  const x = ((e.clientX-rect.left)/rect.width)*100;
  const y = ((e.clientY-rect.top)/rect.height)*100;
  const text = prompt('메모 내용을 입력하세요:');
  if(text===null) return;
  const list = structPins();
  list.push({id:uuid(), x:+x.toFixed(2), y:+y.toFixed(2), text:text.trim()});
  setStructPins(list); renderStructPinLayer();
});
/* Live: Iframe + Images */
function getSrc(){ return localStorage.getItem(STORAGE.SRC) || ''; }
function setSrc(v){
  localStorage.setItem(STORAGE.SRC, v);
  $('srcStatus').innerText='현재: '+(v||'연결되지 않음');
  if(v){ $('liveFrame').src=v; $('splitFrame').src=v; }
  switchToTab('split');
}
$('applySrc').onclick=()=>{ const v=$('srcText').value.trim(); if(v) setSrc(v); };
$('srcFile').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; setSrc(URL.createObjectURL(f)); });

function liveHashForStep(flowKey, stepIdx){
  const f=flows.find(x=>x.key===flowKey); const key=f.map[stepIdx];
  const map={ home:'#home', shop:'#shop', product:'#shop', checkout:'#shop', done:'#mypage',
              apply:'#home', klgc:'#classes', upload:'#shop', publish:'#shop',
              classes:'#classes', detail:'#classes', enroll:'#classes', play:'#classes',
              create:'#classes', sell:'#shop', legacy:'#mypage',
              community:'#community', board:'#community', credit:'#mypage' };
  return map[key] || '#home';
}
function navIframe(){
  const hash = liveHashForStep(activeFlow().key, currentStep);
  try{ $('liveFrame').contentWindow.location.hash=hash; }catch(e){}
  try{ $('splitFrame').contentWindow.location.hash=hash; }catch(e){}
}
/* 이미지 매핑 */
function ensureImgObj(){
  const o=getLS(STORAGE.IMGS, {}); const k=activeFlow().key;
  if(!o[k]) o[k]={ stepMap:{}, gallery:[] };
  setLS(STORAGE.IMGS,o); return o;
}
function imgForStep(flowKey, stepIdx){
  const o=getLS(STORAGE.IMGS, {}); return o?.[flowKey]?.stepMap?.[stepIdx] || '';
}
function assignImages(urls, start){
  const o=ensureImgObj(); const k=activeFlow().key; const d=o[k];
  d.gallery = (d.gallery||[]).concat(urls);
  let s=start; urls.forEach(u=>{ if(s<flowLen()){ d.stepMap[s]=u; s++; } });
  setLS(STORAGE.IMGS, o); renderThumbs(); renderImages();
  switchToTab('live');
  document.querySelector('input[name="source"][value="images"]').checked = true;
}
function renderThumbs(){
  const o=ensureImgObj(); const k=activeFlow().key; const d=o[k];
  const list=$('imgList'); list.innerHTML='';
  const steps=activeFlow().steps; let cnt=0;
  for(let i=0;i<steps.length;i++){
    const url=d.stepMap[i];
    const el=document.createElement('div');
    el.className='thumb'; el.setAttribute('draggable','true'); el.dataset.step=i;
    el.innerHTML = (url?`<button class="del">x</button><img src="${url}">`:'') +
                   `<div class="cap">Step ${i+1}<br>${steps[i].title}${url?'':'<br>(비어 있음)'}</div>`;
    el.querySelector('.del')?.addEventListener('click', ev=>{ ev.stopPropagation(); delete d.stepMap[i]; setLS(STORAGE.IMGS,o); renderThumbs(); renderImages(); });
    el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', i.toString()); el.classList.add('dragging'); });
    el.addEventListener('dragend',   ev=>{ el.classList.remove('dragging'); });
    el.addEventListener('dragover',  ev=>{ ev.preventDefault(); el.classList.add('drag-over'); });
    el.addEventListener('dragleave', ev=>{ el.classList.remove('drag-over'); });
    el.addEventListener('drop',      ev=>{
      ev.preventDefault(); el.classList.remove('drag-over');
      const from=parseInt(ev.dataTransfer.getData('text/plain'),10), to=i;
      const a=d.stepMap[from], b=d.stepMap[to];
      if(a===undefined && b===undefined) return;
      d.stepMap[from]=b; d.stepMap[to]=a; setLS(STORAGE.IMGS,o); renderThumbs(); renderImages();
    });
    list.appendChild(el); if(url) cnt++;
  }
  $('imgInfo').innerText=`매핑됨: ${cnt}/${steps.length} 단계 · DnD로 스텝 간 교체`;
}
$('btnPickImages').onclick=()=>$('imgFiles').click();
$('imgFiles').addEventListener('change', e=>{
  const files=Array.from(e.target.files||[]); if(!files.length) return;
  const urls=files.map(f=>URL.createObjectURL(f));
  assignImages(urls, currentStep);
});
$('btnAssignFromCurrent').onclick=()=>{
  const o=ensureImgObj(); const k=activeFlow().key; const d=o[k];
  if(!d.gallery || !d.gallery.length){ alert('먼저 이미지를 선택하세요.'); return; }
  d.stepMap={}; let s=currentStep; d.gallery.forEach(u=>{ if(s<flowLen()){ d.stepMap[s]=u; s++; } });
  setLS(STORAGE.IMGS,o); renderThumbs(); renderImages();
  switchToTab('live');
};
$('btnClearMap').onclick=()=>{ const o=ensureImgObj(); o[activeFlow().key].stepMap={}; setLS(STORAGE.IMGS,o); renderThumbs(); renderImages(); };

/* 이미지 핀 */
function pinsObj(){ return getLS(STORAGE.PINS, {}); }
function setPinsObj(x){ setLS(STORAGE.PINS, x); }
function getPins(flowKey=activeFlow().key, step=currentStep){
  const o=pinsObj(); if(!o[flowKey]) o[flowKey]={}; if(!o[flowKey][step]) o[flowKey][step]=[]; setPinsObj(o); return o[flowKey][step];
}
function savePins(list, flowKey=activeFlow().key, step=currentStep){
  const o=pinsObj(); if(!o[flowKey]) o[flowKey]={}; o[flowKey][step]=list; setPinsObj(o);
}
let pinMode=false;
$('pinMode').addEventListener('change', e=>{ pinMode=e.target.checked; });
$('btnClearPins').addEventListener('click', ()=>{ savePins([]); renderPins(); });

$('imgBoard').addEventListener('click', (e)=>{
  if(!pinMode) return;
  if(!imgForStep(activeFlow().key, currentStep)){ alert('이 단계에 이미지가 없습니다.'); return; }
  const rect=$('imgBoard').getBoundingClientRect();
  const x=((e.clientX-rect.left)/rect.width)*100, y=((e.clientY-rect.top)/rect.height)*100;
  const text=prompt('핀 설명을 입력하세요:'); if(text===null) return;
  const list=getPins(); list.push({id:uuid(), x:+x.toFixed(2), y:+y.toFixed(2), text:text.trim()});
  savePins(list); renderPins();
});
function renderPins(){
  renderPinLayer('pinLayer', getPins());
  renderPinLayer('splitPinLayer', getPins());
}
function renderPinLayer(layerId, list){
  const layer=$(layerId); if(!layer) return; layer.innerHTML='';
  list.forEach((p,idx)=>{
    const pin=document.createElement('div');
    pin.className='pin'; pin.innerText=String(idx+1);
    pin.style.left=p.x+'%'; pin.style.top=p.y+'%';
    const note=document.createElement('div'); note.className='pinNote'; note.textContent=p.text||'(설명 없음)'; note.style.display='none';
    pin.addEventListener('mouseenter', ()=>{ note.style.display='block'; });
    pin.addEventListener('mouseleave', ()=>{ note.style.display='none'; });
    pin.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const v=prompt('핀 수정 (비우면 삭제)', p.text||''); if(v===null) return;
      const arr=list.slice();
      if(v.trim()===''){ savePins(arr.filter(x=>x.id!==p.id)); } else { p.text=v.trim(); savePins(arr); }
      renderPins();
    });
    const wrap=document.createElement('div'); wrap.style.position='absolute'; wrap.style.left=p.x+'%'; wrap.style.top=p.y+'%'; wrap.style.transform='translate(-50%,-50%)';
    wrap.appendChild(pin); wrap.appendChild(note); layer.appendChild(wrap);
  });
}
function renderImages(){
  const url = imgForStep(activeFlow().key, currentStep) || '';
  const img = $('stepImg'); if(img) img.src=url;
  $('splitImg').src = url;
  renderPins();
}
/* 편집 보조: 삭제/삽입 시 재인덱싱 */
function shiftAfterDelete(flowKey, delIdx){
  const o = getLS(STORAGE.IMGS, {});
  if(o?.[flowKey]?.stepMap){
    const m = o[flowKey].stepMap, nm = {};
    Object.keys(m).forEach(k=>{
      const i = +k;
      if(i < delIdx) nm[i] = m[i];
      else if(i > delIdx) nm[i-1] = m[i];
    });
    o[flowKey].stepMap = nm; setLS(STORAGE.IMGS, o);
  }
  const p = getLS(STORAGE.PINS, {});
  if(p?.[flowKey]){
    const np = {};
    Object.keys(p[flowKey]).forEach(k=>{
      const i=+k;
      if(i < delIdx) np[i]=p[flowKey][i];
      else if(i > delIdx) np[i-1]=p[flowKey][i];
    });
    p[flowKey]=np; setLS(STORAGE.PINS, p);
  }
  const sp = getLS(STORAGE.SPINS, {});
  if(sp?.[flowKey]){
    const nsp={};
    Object.keys(sp[flowKey]).forEach(k=>{
      const i=+k;
      if(i < delIdx) nsp[i]=sp[flowKey][i];
      else if(i > delIdx) nsp[i-1]=sp[flowKey][i];
    });
    sp[flowKey]=nsp; setLS(STORAGE.SPINS, sp);
  }
}
function shiftAfterInsert(flowKey, insIdx){
  const o = getLS(STORAGE.IMGS, {});
  if(o?.[flowKey]?.stepMap){
    const m = o[flowKey].stepMap, nm = {};
    Object.keys(m).map(k=>+k).sort((a,b)=>b-a).forEach(i=>{
      if(i >= insIdx) nm[i+1]=m[i]; else nm[i]=m[i];
    });
    o[flowKey].stepMap = nm; setLS(STORAGE.IMGS, o);
  }
  const p = getLS(STORAGE.PINS, {});
  if(p?.[flowKey]){
    const np={};
    Object.keys(p[flowKey]).map(k=>+k).sort((a,b)=>b-a).forEach(i=>{
      if(i >= insIdx) np[i+1]=p[flowKey][i]; else np[i]=p[flowKey][i];
    });
    p[flowKey]=np; setLS(STORAGE.PINS, p);
  }
  const sp = getLS(STORAGE.SPINS, {});
  if(sp?.[flowKey]){
    const nsp={};
    Object.keys(sp[flowKey]).map(k=>+k).sort((a,b)=>b-a).forEach(i=>{
      if(i >= insIdx) nsp[i+1]=sp[flowKey][i]; else nsp[i]=sp[flowKey][i];
    });
    sp[flowKey]=nsp; setLS(STORAGE.SPINS, sp);
  }
}
/* 탭 & 소스 전환 */
function currentMode(){ return document.querySelector('input[name="source"]:checked').value; }
function switchPanel(panel){
  $('structPanel').style.display = (panel==='struct')?'block':'none';
  $('livePanel').style.display   = (panel==='live')?'grid':'none';
  $('splitPanel').style.display  = (panel==='split')?'grid':'none';
  const mode=currentMode();
  $('srcIframeBox').style.display = (mode==='iframe')?'block':'none';
  $('srcImagesBox').style.display = (mode==='images')?'block':'none';
  $('imagesPane').style.display   = (panel!=='live') ? 'none' : (mode==='images'?'block':'none');
  $('iframePane').style.display   = (panel!=='live') ? 'none' : (mode==='iframe'?'block':'none');
}
function switchToTab(panel){
  document.querySelectorAll('.tab').forEach(b=>{
    b.classList.toggle('active', b.dataset.panel===panel);
  });
  switchPanel(panel);
}
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{ 
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    switchPanel(btn.getAttribute('data-panel'));
    saveState();
  });
});
document.querySelectorAll('input[name="source"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    localStorage.setItem(STORAGE.MODE, currentMode());
    switchToTab('live');
    saveState();
  });
});

/* Flow 리스트 + DnD */
function buildFlowList(){
  const list=$('flowList'); list.innerHTML='';
  flows.forEach((f,idx)=>{
    const el=document.createElement('div');
    el.className='flow'+(idx===currentFlowIdx?' active':''); el.draggable=true; el.dataset.idx=idx;
    el.innerHTML=`<div><strong>${f.title}</strong></div><div class="meta">${f.steps.length} 단계</div><div class="reord">↕</div>`;
    el.addEventListener('click', (e)=>{ if(e.target.classList.contains('reord')) return; selectFlow(idx); });
    el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', idx.toString()); el.classList.add('dragging'); });
    el.addEventListener('dragend',   ev=>{ el.classList.remove('dragging'); });
    el.addEventListener('dragover',  ev=>{ ev.preventDefault(); el.classList.add('drag-over'); });
    el.addEventListener('dragleave', ev=>{ el.classList.remove('drag-over'); });
    el.addEventListener('drop',      ev=>{
      ev.preventDefault(); el.classList.remove('drag-over');
      const from=parseInt(ev.dataTransfer.getData('text/plain'),10), to=idx;
      if(from===to) return;
      const item=flows.splice(from,1)[0]; flows.splice(to,0,item);
      setLS(STORAGE.ORDER, flows.map(x=>x.key));
      saveFlowsToLS(flows);
      buildFlowList();
      saveState();
    });
    list.appendChild(el);
  });
}
function selectFlow(idx){
  currentFlowIdx = idx; currentStep=0;
  document.querySelectorAll('.flow').forEach((x,i)=>x.classList.toggle('active', i===idx));
  renderAll();
  renderThumbs();
  navIframe();
  saveState();
}

/* 네비게이션 버튼 */
$('btnPrev').addEventListener('click', ()=>{ if(currentStep>0){ currentStep--; renderAll(); saveState(); } });
$('btnNext').addEventListener('click', ()=>{ if(currentStep<flowLen()-1){ currentStep++; renderAll(); saveState(); } });
function renderAll(){
  renderStructure();
  renderImages();
  navIframe();
}
/* 단계 편집: 추가/이름변경/삭제 */
$('btnStepAdd').addEventListener('click', ()=>{
  const f = activeFlow();
  const title = (prompt('새 단계 이름?', 'New Step')||'').trim();
  if(!title) return;
  const body  = (prompt('설명(선택):', '')||'').trim();
  const insertAt = currentStep+1;
  shiftAfterInsert(f.key, insertAt);
  f.steps.splice(insertAt, 0, { title, body: body||'설명 없음' });
  f.map.splice(insertAt, 0, f.map[currentStep] || 'home');
  saveFlowsToLS(flows);
  currentStep = insertAt;
  renderAll(); renderThumbs(); navIframe(); saveState();
});
$('btnStepRename').addEventListener('click', ()=>{
  const f = activeFlow();
  const s = f.steps[currentStep];
  const next = (prompt('단계 이름 변경:', s.title)||'').trim();
  if(!next) return;
  s.title = next;
  const body = prompt('설명 변경(비우면 유지):', s.body||'');
  if(body!==null && body.trim()!=='') s.body = body.trim();
  saveFlowsToLS(flows);
  renderAll(); renderThumbs(); saveState();
});
$('btnStepDelete').addEventListener('click', ()=>{
  const f = activeFlow();
  if(f.steps.length<=1){ alert('최소 1단계는 필요합니다.'); return; }
  if(!confirm(`현재 단계 "${f.steps[currentStep].title}" 를 삭제할까요?`)) return;
  const delIdx = currentStep;
  shiftAfterDelete(f.key, delIdx);
  f.steps.splice(delIdx,1);
  f.map.splice(delIdx,1);
  if(currentStep>=f.steps.length) currentStep=f.steps.length-1;
  saveFlowsToLS(flows);
  renderAll(); renderThumbs(); navIframe(); saveState();
});

/* 초기 시작 */
(function init(){
  initFlows();
  buildFlowList();
  const savedMode = localStorage.getItem(STORAGE.MODE);
  if(savedMode){ const el=document.querySelector(`input[name="source"][value="${savedMode}"]`); if(el) el.checked=true; }
  const src = getSrc(); if(src){ setSrc(src); }
  selectFlow(0);
  loadState();          // 마지막 세션 복원
  renderAll();          // 경계 보정
})();
</script>
</body>
</html>