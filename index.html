<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Knitverse Â· Hybrid Storyboard v9.0 (Firebase Sync)</title>
<!-- ğŸ—‘ï¸ ê¸°ì¡´ LZ-String ë° í˜¸í™˜ì„± SDK ì œê±°, ìµœì‹  ëª¨ë“ˆ ë°©ì‹ SDK ì¶”ê°€ -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Noto+Sans+KR:wght@400;600;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<!-- ğŸ”¥ Firebase v9 CDN ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ (Firestore, Storage, App) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

    // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œí•˜ì—¬ ì•„ë˜ <script>ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
    window.initializeApp = initializeApp;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.getStorage = getStorage;
    window.ref = ref;
    window.uploadString = uploadString;
    window.getDownloadURL = getDownloadURL;
    window.deleteObject = deleteObject;
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script> 
<style>
  :root{ --bg:#0b0c10; --panel:#10151b; --card:#141c26; --text:#eaf2ff; --muted:#a9b7c6; --blue:#35d0ff; --gold:#ffd54f; --line:#223244; }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 80% -10%, #16212c 0%, var(--bg) 55%);color:var(--text);
       font:14px/1.6 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  header{position:sticky;top:0;z-index:20;background:rgba(10,14,20,.85);backdrop-filter:blur(8px);border-bottom:1px solid #162433;
         display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px}
  .brand{font-family:'Orbitron';letter-spacing:.14em;color:#35d0ff;font-weight:800;text-transform:uppercase;text-shadow:0 0 10px #35d0ff77}
  .wrap{display:grid;grid-template-columns:400px 1fr;gap:14px;padding:14px}
  @media(max-width:1400px){.wrap{grid-template-columns:1fr}}
  aside{background:var(--panel);border:1px solid #1b2a3a;border-radius:14px;padding:12px;overflow-y:auto;max-height:calc(100vh - 28px - 48px)}
  .section-title{margin:6px 0 8px;font-weight:800;color:#d6e6ff}
  .flow-tools{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .flow-list{display:grid;gap:8px}
  .flow{background:linear-gradient(180deg,#0f141b,#0f1822);border:1px solid #203044;border-radius:12px;padding:10px;cursor:grab;position:relative}
  .flow.active{border-color:var(--gold);box-shadow:0 0 0 2px #ffd54f33}
  .flow.drag-over{outline:2px dashed #35d0ff}
  .flow .reord{position:absolute;top:8px;right:8px;font-size:10px;color:#96b}
  /* V6.0: í”Œë¡œìš° ëª©ë¡ì˜ ë‹¨ê³„ ìˆ˜ í‘œì‹œ ì œê±°ë¥¼ ìœ„í•´ meta ìŠ¤íƒ€ì¼ ìˆ¨ê¹€ */
  .meta{color:#9eb0c6;font-size:12px;line-height:1.4; display: none;} 
  .meta-content{min-height:24px}
  .picker{display:grid;gap:8px;background:#0f141b;border:1px solid #203044;border-radius:12px;padding:10px;margin-top:10px}
  input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #223244;background:#0b1219;color:#eaf2ff;font-family:'Roboto Mono'}
  .radio{display:flex;gap:12px;align-items:center;margin:6px 0 2px}
  .small{font-size:12px;color:#9fb0c6}
  
  /* ì¸ë„¤ì¼ ì˜ì—­ */
  .thumbs-section{margin-top:16px; padding-top:16px; border-top:1px solid var(--line);}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin-top:8px}
  .thumb{border:1px solid var(--line);border-radius:10px;padding:6px;background:#0b1219;text-align:center;position:relative;cursor:pointer}
  .thumb.active{border-color:var(--blue);box-shadow:0 0 0 2px #35d0ff33;}
  .thumb[draggable="true"]{cursor:grab}
  .thumb.drag-over{outline:2px dashed #35d0ff}
  .thumb img{max-width:100%;max-height:68px;border-radius:6px;display:block;margin:0 auto 6px}
  .thumb .cap{font-size:11px;color:#cfe2ff}
  .thumb .del{position:absolute;top:6px;right:6px;background:#150e0e;border:1px solid #4a2020;color:#ff9b9b;border-radius:8px;font-size:11px;padding:2px 6px;cursor:pointer;z-index:10}
  
  main{background:var(--panel);border:1px solid #1b2a3a;border-radius:14px;padding:0;overflow:hidden}
  .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px;border-bottom:1px solid #192737}
  .crumbs{color:#b9c7d8;font-size:12px}
  .btn{background:#0f141b;border:1px solid #223244;color:#eaf2ff;padding:8px 12px;border-radius:10px;cursor:pointer;flex-shrink:0}
  .btn.primary{border-color:var(--gold);color:#111;background:var(--gold);font-weight:800}
  .btn.danger{border-color:#4a2020;color:#ff9b9b;background:#150e0e;}
  
  /* V6.0: ì´ë¯¸ì§€ ì„ íƒ ë²„íŠ¼ ê°•ì¡° ìŠ¤íƒ€ì¼ */
  .btn.asset-primary{
      background: #ff9800; /* ì£¼í™©ìƒ‰ ë°°ê²½ */
      border-color: #ffb74d; /* ë°ì€ ì£¼í™©ìƒ‰ í…Œë‘ë¦¬ */
      color: #111; /* ì§„í•œ í…ìŠ¤íŠ¸ */
      font-weight: 800; 
      box-shadow: 0 0 8px #ff980044;
  }
  
  .stage{padding:14px}
  .unified-stage{display:grid;grid-template-columns:1fr 1fr;gap:14px;} 
  @media(max-width:1400px){.unified-stage{grid-template-columns:1fr}}
  .screen-panel{position:relative;background:linear-gradient(180deg,#0f141b,#101a24);border:1px solid #223244;border-radius:12px;padding:14px;min-height:480px;box-shadow:0 14px 44px #0008;height:100%}
  .stage-wrap{display:grid;grid-template-rows:minmax(480px, auto) 1fr;gap:14px;}
  
  /* Structure UI */
  .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:14px}
  .card{position:relative;background:#182330;border-left:4px solid var(--blue);border-radius:8px;padding:10px 12px;transition:all .1s; cursor:grab;}
  .card.dragging{ opacity: 0.4; } 
  .card.drag-over{ outline: 2px dashed var(--gold); }
  .card:hover{border-left-color:var(--gold);background:#1d2938}
  .card strong{color:var(--blue);font-size:12px;text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:2px}
  .card[data-slot*="link"] strong{color:#c7ff35} 
  .card[data-slot*="metric"] strong{color:#ff9933} 
  .meta-content{color:var(--text);font-size:14px;font-weight:600;line-height:1.4;min-height:20px}
  
  /* HOME (ì œëª©) ë° ì„¤ëª… í¸ì§‘ ê°€ëŠ¥ ìŠ¤íƒ€ì¼ */
  h2{margin-top:0;font-size:1.6em;border-bottom:1px solid var(--line);padding-bottom:10px;margin-bottom:10px;color:var(--gold);cursor:pointer}
  .struct-desc{color:#d6e6ff;font-size:14px;line-height:1.5;margin-bottom:20px;cursor:pointer}
  
  .progress{height:8px;background:#0c1219;border:1px solid #1e2b3a;border-radius:999px;overflow:hidden;margin:8px 0 0}
  .bar{height:100%;background:linear-gradient(90deg,#35d0ff,#ffd54f);width:0%}
  
  iframe{width:100%;height:100%;min-height:540px;border:1px solid #223244;border-radius:12px;background:#0b0c10}
  .imgStageWrap{background:linear-gradient(180deg,#0f141b,#0f1721);border:1px solid #203044;border-radius:12px;padding:10px;height:100%;}
  /* V5.4: Live ì´ë¯¸ì§€ íˆ´ë°” ë° í•€ ë²„íŠ¼ ì˜ì—­ */
  .imgTools{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap;padding: 0 4px;} 
  /* V5.4: ìŠ¤í¬ë¡¤ë°” ë°©ì§€ CSS ê°•í™” */
  .imgBoard{position:relative;display:flex;align-items:center;justify-content:center;min-height:540px;background:#0b0c10;border:1px dashed #234;border-radius:12px;
            max-width:100%; max-height:100%; overflow:hidden;} /* overflow:hidden ì¶”ê°€ */
  .imgBoard img{max-width:100%;max-height:100%;width:auto;height:auto;border-radius:8px;display:block;object-fit:contain;}
  
  .pinLayer{position:absolute;inset:0;pointer-events:none}
  .pin{position:absolute;transform:translate(-50%,-50%);background:#ffd54f;color:#111;border:2px solid #111;border-radius:999px;width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;pointer-events:auto;cursor:pointer}
  .pin:hover{box-shadow:0 0 0 4px #ffd54f33}
  .pinNote{position:absolute;transform:translate(8px,-50%);background:#141c26;color:#eaf2ff;border:1px solid #223244;border-radius:8px;padding:6px;min-width:160px;max-width:260px;font-size:12px}
  .hint{font-size:12px;color:#9fb0c6}
  
  /* Structure íˆ´ë°”: ë‹¨ê³„ ê´€ë¦¬ ë²„íŠ¼ í†µí•© */
  .structTools{position:relative;display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding-bottom:10px;margin-bottom:10px;border-bottom:1px solid var(--line);}
  .slot-tools{margin-top:10px;padding-top:10px;border-top:1px dashed var(--line);}
</style>
</head>
<body>
<header>
  <div class="brand">KNITVERSE Â· Hybrid Storyboard V9.0</div>
</header>
<div class="wrap" id="mainWrapper">
  <aside>
    <div class="section-title">í”Œë¡œìš° ì„ íƒ (ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½)</div>
    <div class="flow-tools">
        <button class="btn" id="btnAddFlow">í”Œë¡œìš° ì¶”ê°€</button>
        <button class="btn" id="btnRenameFlow">ì´ë¦„ ë³€ê²½</button>
        <button class="btn danger" id="btnDeleteFlow">ì‚­ì œ</button>
    </div>
    <div class="flow-list" id="flowList"></div>

    <div class="section-title" style="margin-top:16px">Live Demo ì†ŒìŠ¤</div>
    <div class="picker">
      <label>Iframe (HTML) íŒŒì¼ ê²½ë¡œ/ì´ë¦„ ì…ë ¥</label>
      <div id="srcIframeBox">
        <input id="srcText" type="text" placeholder="ì˜ˆ: knitverse_mvp_skin_pro.html ë˜ëŠ” ./sub/app.html">
        <button class="btn" id="applySrc">ì ìš©</button>
        <div class="small">ë˜ëŠ” íŒŒì¼ ì„ íƒ â†’</div>
        <input id="srcFile" type="file" accept=".html,.htm">
        <div class="small" id="srcStatus">í˜„ì¬: ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
      </div>
    </div>
    
    <div class="thumbs-section">
        <div class="section-title">ë‹¨ê³„ë³„ ì´ë¯¸ì§€ ì‚½ì… (Step Images)</div>
        <div class="small">ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.</div>
        <div class="imgTools" style="padding: 10px 0;">
            <button class="btn asset-primary" id="btnPickImages">ì´ë¯¸ì§€ ì„ íƒ</button>
            <button class="btn" id="btnAssignFromCurrent">í˜„ì¬ ë‹¨ê³„ë¶€í„° ì¬í• ë‹¹</button>
            <button class="btn danger" id="btnClearMap">ì´ í”Œë¡œìš° ë§¤í•‘ ì´ˆê¸°í™”</button>
            <input id="imgFiles" type="file" accept="image/*" multiple style="display:none">
            <div class="small" id="imgInfo" style="flex-basis: 100%;"></div>
        </div>
        
        <div class="thumbs" id="imgList"></div>
        <div class="small">ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ì´ë¯¸ì§€ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥. ì¸ë„¤ì¼ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ê³„ë¡œ ì´ë™.</div>
    </div>

    <!-- V9.0: JSON ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ì„¹ì…˜ ìˆ¨ê¹€ (Firebaseê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥í•˜ë¯€ë¡œ) -->
    <div class="thumbs-section" style="display:none">
        <div class="section-title">ì‘ì—… ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° (JSON)</div>
        <label class="small" style="margin-top: 8px;">ì €ì¥í•  íŒŒì¼ëª… (í™•ì¥ì ì œì™¸)</label>
        <input id="saveFileName" type="text" placeholder="ì˜ˆ: knitverse_project_final" style="margin-bottom: 8px;">
        
        <button class="btn primary" id="btnExportWork">ì‘ì—… ì €ì¥ (JSON)</button> 

        <div style="height: 10px;"></div>
        <button class="btn" id="btnImportWork">ì‘ì—… ë¶ˆëŸ¬ì˜¤ê¸° (íŒŒì¼ ì„ íƒ)</button>
        <input id="workFile" type="file" accept=".json" style="display:none">
        <div class="small">ì €ì¥ëœ JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ ì‘ì—… í™˜ê²½ì„ ë³µì›í•©ë‹ˆë‹¤.</div>
    </div>
    
  </aside>
  <main id="mainContent">
    <div class="toolbar">
      <div class="crumbs" id="crumbs">HOME</div>
      <div class="controls">
        <button class="btn" id="btnExportImage">í™”ë©´ ìº¡ì²˜ (PNG)</button> 
        <button class="btn" id="btnPrev">â† ì´ì „</button>
        <button class="btn primary" id="btnNext">ë‹¤ìŒ â†’</button>
      </div>
    </div>

    <div class="stage unified-stage">
      
      <div id="structPanel" class="screen-panel">
        <div class="structTools">
          <button class="btn" id="btnStepAdd">ë‹¨ê³„ ì¶”ê°€</button>
          <button class="btn" id="btnStepClone">í˜„ì¬ ë‹¨ê³„ ë³µì œ</button>
          <button class="btn" id="btnStepRename">ì´ë¦„ ë³€ê²½</button>
          <button class="btn danger" id="btnStepDelete">ë‹¨ê³„ ì‚­ì œ</button>
          <div style="flex-basis:100%; height:8px;"></div>
          <label class="small"><input type="checkbox" id="structPinMode"> í•€ ì¶”ê°€</label> 
          <button class="btn" id="btnStructClearPins">í•€ ì‚­ì œ</button>
        </div>
        <div id="structBody"></div>
        <div class="pinLayer" id="structPinLayer"></div>
      </div>

      <div class="stage-wrap">
        <div id="iframePane" class="imgStageWrap" style="display:none">
          <div class="imgTools">
            <span class="hint">Live Demo (Iframe) ì˜ì—­ì…ë‹ˆë‹¤. (Step Imagesê°€ ìš°ì„ ì…ë‹ˆë‹¤.)</span>
          </div>
          <iframe id="liveFrame"></iframe>
          <div class="hint">í•´ì‹œ ë‚´ë¹„(#home/#shop/#classes/#mypage)ë¡œ ìŠ¤í… ì´ë™ì— ë§ì¶° ì—°ë™í•©ë‹ˆë‹¤.</div>
        </div>
        <div id="imagesPane" class="imgStageWrap" style="display:none">
          <div class="imgTools">
            <label><input type="checkbox" id="pinMode"> í•€ ì¶”ê°€</label>
            <button class="btn" id="btnClearPins">í•€ ì‚­ì œ</button>
            <span class="hint">ì´ë¯¸ì§€ ìœ„ë¥¼ í´ë¦­í•˜ë©´ í•€ê³¼ ì„¤ëª…ì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.</span>
          </div>
          <div class="imgBoard" id="imgBoard">
            <img id="stepImg" alt="Step image">
            <div class="pinLayer" id="pinLayer"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="progress" style="margin-top:14px"><div class="bar" id="bar"></div></div>
    <footer id="footer"></footer>
  </main>
</div>

<div id="loadingOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; color:white; font-size:16px;">
    <div style="width:300px; padding:20px; background:#141c26; border-radius:12px; border:1px solid #35d0ff;">
        <div style="font-weight:bold; margin-bottom:10px;" id="loadingTitle">ì‘ì—… ë°ì´í„° ì €ì¥ ì¤€ë¹„ ì¤‘...</div>
        <div id="progressBarContainer" style="height:10px; background:#0b0c10; border-radius:5px; overflow:hidden;">
            <div id="progressBar" style="height:100%; width:0; background:#ffd54f;"></div>
        </div>
        <div id="progressText" style="margin-top:10px; text-align:right;">0%</div>
    </div>
</div>


<script>
/* =========================
   í”Œë¡œìš° ì •ì˜ (5ê°œ) 
========================= */
const BASE_FLOWS=[
 {key:'fan',     title:'íŒ¬ Â· êµ¬ë§¤ í”Œë¡œìš°', map:['home','shop','product','checkout','done'], 
  steps:[
   {title:'HOME',body:'íˆì–´ë¡œ ë°°ë„ˆì—ì„œ ìƒí’ˆ ì§„ì…', slots:[{key:'core', name:'í•µì‹¬ ìš”ì†Œ', content:'CTA Â· ì‚¬ìš©ì ëª©í‘œ Â· ì„±ê³µ ì‹œê·¸ë„'},{key:'link', name:'ì—°ê²°', content:'ì‡¼í•‘ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™'},{key:'metric', name:'ë©”íŠ¸ë¦­', content:'Home to Shop í´ë¦­ë¥ '}]},
   {title:'SHOP',body:'íŠ¸ë Œë”© ìƒí’ˆ ë¦¬ìŠ¤íŠ¸', slots:[{key:'core', name:'ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ í•µì‹¬', content:'ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ í•µì‹¬'},{key:'link', name:'ìƒí’ˆ ìƒì„¸ë¡œ ì´ë™', content:'ìƒí’ˆ ìƒì„¸ë¡œ ì´ë™'},{key:'metric', name:'ìƒí’ˆ ì¡°íšŒìœ¨', content:'ìƒí’ˆ ì¡°íšŒìœ¨'}]},
   {title:'ìƒì„¸',body:'ìƒí’ˆ ìƒì„¸ í˜ì´ì§€', slots:[{key:'core', name:'ìƒí’ˆ ìƒì„¸ í•µì‹¬', content:'ìƒí’ˆ ìƒì„¸ í•µì‹¬'},{key:'link', name:'ì²´í¬ì•„ì›ƒìœ¼ë¡œ ì´ë™', content:'ì²´í¬ì•„ì›ƒìœ¼ë¡œ ì´ë™'},{key:'metric', name:'ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°ìœ¨', content:'ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°ìœ¨'}]},
   {title:'ì²´í¬ì•„ì›ƒ',body:'ê²°ì œ ìš”ì•½ í™”ë©´', slots:[{key:'core', name:'ê²°ì œ í•µì‹¬', content:'ê²°ì œ í•µì‹¬'},{key:'link', name:'ì£¼ë¬¸ ì™„ë£Œ', content:'ì£¼ë¬¸ ì™„ë£Œ'},{key:'metric', name:'ê²°ì œ ì„±ê³µë¥ ', content:'ê²°ì œ ì„±ê³µë¥ '}]},
   {title:'ì™„ë£Œ',body:'ì£¼ë¬¸ ì™„ë£Œ', slots:[{key:'core', name:'ì™„ë£Œ í•µì‹¬', content:'ì™„ë£Œ í•µì‹¬'},{key:'link', name:'ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™', content:'ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™'},{key:'metric', name:'ì¬ë°©ë¬¸ ìœ ë„', content:'ì¬ë°©ë¬¸ ìœ ë„'}]}
  ]},
 {key:'rookie',  title:'ë£¨í‚¤ Â· ì„±ì¥ í”Œë¡œìš°', map:['home','apply','klgc','upload','publish'], steps:[{title:'HOME',body:'APPLY í´ë¦­'},{title:'Apply Form',body:'ì•„í‹°ìŠ¤íŠ¸ ì§€ì› í¼'},{title:'K-LGC',body:'4ì£¼ ì»¤ë¦¬í˜ëŸ¼ ë‹¨ê³„'},{title:'Upload',body:'ìƒí’ˆ ì—…ë¡œë“œ'},{title:'Publish',body:'ìƒí’ˆ ê³µê°œ ì™„ë£Œ'}]},
 {key:'learner', title:'í•™ìŠµì Â· í´ë˜ìŠ¤ í”Œë¡œìš°', map:['home','classes','detail','enroll','play'], steps:[{title:'HOME',body:'í´ë˜ìŠ¤ íƒ­ í´ë¦­'},{title:'Class List',body:'ê°•ì˜ ëª©ë¡'},{title:'Detail',body:'ê°•ì˜ ìƒì„¸ ì„¤ëª…'},{title:'Enroll',body:'ìˆ˜ê°• ë“±ë¡'},{title:'Player',body:'ê°•ì˜ ì¬ìƒ'}]},
 {key:'creator', title:'ì•¡í‹°ë¸Œ/ë§ˆìŠ¤í„° ì‘ê°€ í”Œë¡œìš°', map:['home','classes','create','sell','legacy'], steps:[{title:'HOME',body:'MY PAGEì—ì„œ í¬ë¦¬ì—ì´í„° í—ˆë¸Œ ì§„ì…'},{title:'í´ë˜ìŠ¤ ê°œì„¤',body:'ì»¤ë¦¬í˜ëŸ¼/ê°€ê²©/ì–¸ì–´ ì„¤ì •'},{title:'ìƒí’ˆí™”',body:'í‚¤íŠ¸/ë„ì•ˆ ë²ˆë“¤ êµ¬ì„± Â· ì¬ê³ '},{title:'íŒë§¤/í”„ë¡œëª¨ì…˜',body:'ëŸ°ì¹­ Â· íŒ¬/ì»¤ë®¤ë‹ˆí‹° í”„ë¡œëª¨ì…˜'},{title:'ë ˆê±°ì‹œ ì¶•ì ',body:'ë©˜í† ë§/í‰ê°€ Â· ë ˆê±°ì‹œ ìŠ¤ì½”ì–´ ìƒìŠ¹'}]},
 {key:'support', title:'ì„œí¬í„°ì¦ˆ í”Œë¡œìš°', map:['home','community','apply','board','credit'], steps:[{title:'HOME',body:'COMMUNITY ì§„ì…'},{title:'Supporter Hub',body:'ì—­í•  ì„ íƒ/ê°€ìš©ì„± ì„¤ì •'},{title:'Apply',body:'í”„ë¡œí•„ ì œì¶œ'},{title:'Matching Board',body:'í”„ë¡œì íŠ¸ ë§¤ì¹­/ìŠ¹ì¸'},{title:'í¬ë ˆë”§ & ë³´ìƒ',content:'K-Points ì ë¦½/ì •ì‚°'}]}
];

/* =========================
   Firebase ì´ˆê¸°í™” & ìƒíƒœ ì •ì˜
========================= */

// ğŸ’¡ [ì—¬ê¸°ë¥¼ ì£¼ëª©!] ë³µì‚¬í•´ì£¼ì‹  Firebase Config ì •ë³´ê°€ ì •í™•íˆ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
const firebaseConfig = {
    apiKey: "AIzaSyD9SfwCbyHlGBr8GtbTx5bNvRB4g3VazfU",
    authDomain: "knitverse-storyboard-sync.firebaseapp.com",
    projectId: "knitverse-storyboard-sync",
    storageBucket: "knitverse-storyboard-sync.firebasestorage.app",
    messagingSenderId: "638143951233",
    appId: "1:638143951233:web:d48e4eb1fd59f595d0f880"
};

// ğŸ’¡ Firebase ì„œë¹„ìŠ¤ ê°ì²´ ì •ì˜
const app = window.initializeApp(firebaseConfig);
const db = window.getFirestore(app);
const storage = window.getStorage(app); 

// ğŸ’¡ í˜„ì¬ í”Œë¡œìš° ë°ì´í„°ê°€ ì €ì¥ë  Firestoreì˜ ê²½ë¡œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
//    ì´ ê²½ë¡œëŠ” ëª¨ë“  ê¸°íšìê°€ ë™ì¼í•˜ê²Œ ì‚¬ìš©í•˜ë©° ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
const FIREBASE_DOC_PATH = 'teams/knitverse';
const FLOWS_REF = window.doc(db, FIREBASE_DOC_PATH, 'flows'); 
const PINS_REF = window.doc(db, FIREBASE_DOC_PATH, 'pins'); 
const SPINS_REF = window.doc(db, FIREBASE_DOC_PATH, 'structPins'); 
const STATE_REF = window.doc(db, FIREBASE_DOC_PATH, 'state');
const IMAGES_REF = window.doc(db, FIREBASE_DOC_PATH, 'imgSrc');

/* =========================
   ìƒíƒœ & ì €ì¥ í‚¤ + í—¬í¼
========================= */
let flows = [];
let currentFlowIdx = 0;
let currentStep = 0;

let pins = {}; // ì´ë¯¸ì§€ í•€ ë°ì´í„° (Firestore ë™ê¸°í™”)
let structPinsData = {}; // êµ¬ì¡° í•€ ë°ì´í„° (Firestore ë™ê¸°í™”)
let imgSrc = {}; // ì´ë¯¸ì§€ê°€ Storage URLë¡œ ì €ì¥ë  ë§µ (Firestore ë™ê¸°í™”)

const STORAGE = {
  SRC:   'kv_v50_src', // iframe ê²½ë¡œë§Œ ë¡œì»¬ ì €ì¥
};

function $(id){ return document.getElementById(id); }
function uuid(){ return Math.random().toString(36).slice(2,10); }
function activeFlow(){ return flows[currentFlowIdx]; }
function flowLen(){ return activeFlow()?.steps?.length || 0; }
function activeStepData(){ return activeFlow()?.steps?.[currentStep]; }

/* =========================
   Firebase ë™ê¸°í™” ë¡œì§
========================= */

// V9.0: ë°ì´í„° ì €ì¥ ë¡œì§ (ëª¨ë“  ë³€ê²½ì€ ì´ í•¨ìˆ˜ë¥¼ í†µí•´ Firebaseì— ë°˜ì˜ë©ë‹ˆë‹¤.)
function saveFlows(flowsArr = flows) {
    if (flowsArr && flowsArr.length > 0) {
        window.setDoc(FLOWS_REF, { flows: flowsArr }, { merge: true })
            .catch(e => console.error("Error saving flows:", e));
    }
}

function saveState() {
    // íë¦„ ì¸ë±ìŠ¤ê°€ ìœ íš¨í•  ë•Œë§Œ ì €ì¥
    if (currentFlowIdx < 0 || currentFlowIdx >= flows.length) return; 
    window.setDoc(STATE_REF, { flowIdx: currentFlowIdx, stepIdx: currentStep }, { merge: true })
        .catch(e => console.error("Error saving state:", e));
}

// ì´ˆê¸°í™” ì‹œ Firestore ë¦¬ìŠ¤ë„ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
function startDataListeners() {
    // 1. FLOWS (í”Œë¡œìš° êµ¬ì¡°, ë‹¨ê³„, ìŠ¬ë¡¯ ì½˜í…ì¸ ) ë¦¬ìŠ¤ë„ˆ
    window.onSnapshot(FLOWS_REF, (doc) => {
        const data = doc.data();
        if (data && Array.isArray(data.flows) && data.flows.length > 0) {
            flows = data.flows;
            // V5.5 í˜¸í™˜ì„±: ìŠ¬ë¡¯ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŠ¬ë¡¯ ì¶”ê°€
            flows.forEach(f => {
                f.steps.forEach(s => {
                    if(!s.slots){
                        s.slots = [
                           {key:'core', name:'í•µì‹¬ ìš”ì†Œ', content: s.core || 'í•µì‹¬ ìš”ì†Œ'},
                           {key:'link', name:'ì—°ê²°', content: 'ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” íŠ¸ë¦¬ê±°'},
                           {key:'metric', name:'ë©”íŠ¸ë¦­', content: 'ì „í™˜/ì´íƒˆ í¬ì¸íŠ¸, GA ì´ë²¤íŠ¸'}
                       ];
                    }
                    if(!s.body) s.body = 'ì„¤ëª… ì—†ìŒ';
                });
            });
            buildFlowList();
            renderAll();
        } else {
            // Firestoreì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ BASE_FLOWSë¡œ ì´ˆê¸°í™”í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.
            if(flows.length === 0) {
                console.log('No flows data in Firestore. Initializing...');
                flows = JSON.parse(JSON.stringify(BASE_FLOWS));
                saveFlows(flows);
            }
        }
    });

    // 2. PINS (ì´ë¯¸ì§€ í•€) ë¦¬ìŠ¤ë„ˆ
    window.onSnapshot(PINS_REF, (doc) => {
        const data = doc.data();
        if (data) {
            pins = data;
            renderPins();
        }
    });

    // 3. STRUCT PINS (êµ¬ì¡° í•€) ë¦¬ìŠ¤ë„ˆ
    window.onSnapshot(SPINS_REF, (doc) => {
        const data = doc.data();
        if (data) {
            structPinsData = data;
            renderStructPinLayer();
        }
    });
    
    // 4. IMAGE SRC (ì´ë¯¸ì§€ URL ë§µ) ë¦¬ìŠ¤ë„ˆ
    window.onSnapshot(IMAGES_REF, (doc) => {
        const data = doc.data();
        if (data) {
            imgSrc = data;
            renderThumbs();
            renderImages();
        }
    });

    // 5. STATE (í˜„ì¬ ìœ„ì¹˜: flowIdx, stepIdx) ë¦¬ìŠ¤ë„ˆ
    window.onSnapshot(STATE_REF, (doc) => {
        const data = doc.data();
        if (data) {
            // ë°ì´í„° ìˆ˜ì‹  ì‹œ, í˜„ì¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  í™”ë©´ì„ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
            currentFlowIdx = Math.min(Math.max(0, data.flowIdx || 0), flows.length - 1);
            currentStep = Math.min(Math.max(0, data.stepIdx || 0), flowLen() - 1);
            renderAll();
        }
    });
}

function initFlows(){
    startDataListeners();
}

/* =========================
   Structure: í•€/ë©”ëª¨ + ì¹´ë“œ ë°ì´í„° (Firestore ì—°ë™)
========================= */
function structPins(flowKey = activeFlow().key, step = currentStep){
  if(!structPinsData[flowKey]) structPinsData[flowKey]={};
  if(!structPinsData[flowKey][step]) structPinsData[flowKey][step]=[];
  return structPinsData[flowKey][step];
}
function setStructPins(list, flowKey = activeFlow().key, step = currentStep){
  if(!structPinsData[flowKey]) structPinsData[flowKey]={};
  structPinsData[flowKey][step]=list;
  
  window.setDoc(SPINS_REF, structPinsData, { merge: true })
    .catch(e => console.error("Error saving struct pins:", e));
  saveState();
}

function renderStructure(){
  const f=activeFlow(), s=activeStepData();
  if(!f || !s) { $('structBody').innerHTML = 'ë¡œë”© ì¤‘...'; return; } // ë°ì´í„° ë¡œë”© ì¤‘ ì²˜ë¦¬
  
  const flowStepsSummary = f.steps.map(step => step.title).join(' - ');

  let slotsHtml = '';
  if(s.slots && Array.isArray(s.slots)){
    slotsHtml = s.slots.map((slot, index) => `
      <div class="card" data-key="${slot.key}" data-slot-name="${slot.name}" draggable="true" data-index="${index}">
        <strong>${slot.name} (${slot.key.toUpperCase().split('_')[0]})</strong>
        <div class="meta-content">${slot.content || ''}</div>
      </div>
    `).join('');
  }
  
  $('structBody').innerHTML = `
    <h2 id="stepTitle" class="editable-title">${s.title}</h2>
    <p id="stepBody" class="struct-desc editable-body">${s.body||'ì„¤ëª… ì—†ìŒ'}</p>
    <div class="grid">${slotsHtml}</div>
    <div class="slot-tools">
        <button class="btn" id="btnAddSlot">ìŠ¬ë¡¯ ì¶”ê°€</button>
        <button class="btn danger" id="btnDeleteSlot">ìŠ¬ë¡¯ ì‚­ì œ</button>
    </div>
    `;

  $('crumbs').innerText = f.title + ' â€º ' + flowStepsSummary; 
  $('bar').style.width = ((currentStep+1)/flowLen()*100)+'%';
  $('footer').innerText = `${f.title} Â· Step ${currentStep+1}/${flowLen()}`;
  $('btnPrev').disabled = currentStep===0;
  $('btnNext').disabled = currentStep===flowLen()-1;

  renderStructPinLayer();
  attachEditListeners();
}

// í¸ì§‘ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
function attachEditListeners(){
    const s = activeStepData();
    
    // 1. ë‹¨ê³„ ì œëª© í¸ì§‘
    $('stepTitle').addEventListener('dblclick', (e) => {
        const newTitle = prompt('ë‹¨ê³„ ì´ë¦„ ë³€ê²½:', s.title);
        if (newTitle !== null && newTitle.trim() !== '') {
            s.title = newTitle.trim();
            saveFlows(flows); // Firebase ì €ì¥
            renderAll();
        }
    });

    // 2. ë‹¨ê³„ ì„¤ëª… í¸ì§‘
    $('stepBody').addEventListener('dblclick', (e) => {
        const newBody = prompt('ë‹¨ê³„ ì„¤ëª… ë³€ê²½:', s.body);
        if (newBody !== null) {
            s.body = newBody.trim() || 'ì„¤ëª… ì—†ìŒ';
            saveFlows(flows); // Firebase ì €ì¥
            renderStructure();
        }
    });

    // 3. ìŠ¬ë¡¯ ì½˜í…ì¸  í¸ì§‘
    document.querySelectorAll('#structBody .card').forEach(card => {
        card.addEventListener('dblclick', (e) => {
            if(card.classList.contains('dragging')) return; 
            
            const key = card.dataset.key;
            const slot = s.slots.find(sl => sl.key === key);
            
            const newContent = prompt(`'${slot.name}' ë‚´ìš© ìˆ˜ì •:`, slot.content || '');

            if (newContent !== null) {
                slot.content = newContent.trim();
                saveFlows(flows); // Firebase ì €ì¥
                renderStructure();
            }
        });
    });

    // 4. ìŠ¬ë¡¯ ì¶”ê°€ ë²„íŠ¼
    $('btnAddSlot').addEventListener('click', () => {
        const name = prompt('ìƒˆ ìŠ¬ë¡¯ì˜ ì´ë¦„(ì œëª©)ì„ ì…ë ¥í•˜ì„¸ìš”:').trim();
        if (!name) return;
        const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_').slice(0, 10) + uuid().slice(0,4);
        
        s.slots.push({ key: key, name: name, content: '' });
        saveFlows(flows); // Firebase ì €ì¥
        renderStructure();
    });

    // 5. ìŠ¬ë¡¯ ì‚­ì œ ë²„íŠ¼
    $('btnDeleteSlot').addEventListener('click', () => {
        if (!s.slots || s.slots.length === 0) { alert('ì‚­ì œí•  ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
        
        const slotNames = s.slots.map((sl, idx) => `${idx + 1}. ${sl.name}`).join('\n');
        const indexStr = prompt(`ì‚­ì œí•  ìŠ¬ë¡¯ì˜ ë²ˆí˜¸(1~${s.slots.length})ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\n${slotNames}`);
        const index = parseInt(indexStr, 10) - 1;

        if (index >= 0 && index < s.slots.length) {
            if(confirm(`"${s.slots[index].name}" ìŠ¬ë¡¯ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
                s.slots.splice(index, 1);
                saveFlows(flows); // Firebase ì €ì¥
                renderStructure();
            }
        } else if(indexStr !== null && indexStr.trim() !== ''){
            alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë²ˆí˜¸ì…ë‹ˆë‹¤.');
        }
    });

    // 6. ìŠ¬ë¡¯ ë“œë˜ê·¸ì•¤ë“œë¡­ (ìˆœì„œ ë³€ê²½)
    let dragSrcEl = null;

    document.querySelectorAll('#structBody .card').forEach(card => {
        card.addEventListener('drop', (e) => {
            e.stopPropagation();
            card.classList.remove('drag-over');
            
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
            const toIndex = parseInt(card.dataset.index, 10);

            if (fromIndex !== toIndex) {
                const [movedItem] = s.slots.splice(fromIndex, 1);
                s.slots.splice(toIndex, 0, movedItem);
                
                saveFlows(flows); // Firebase ì €ì¥
                renderStructure(); 
            }
        });
    });
}


let structPinMode=false;
$('structPinMode').addEventListener('change', e=>{ structPinMode = e.target.checked; });
$('btnStructClearPins').addEventListener('click', ()=>{ setStructPins([]); renderStructPinLayer(); });

function renderStructPinLayer(){
  const layer = $('structPinLayer'); layer.innerHTML='';
  const list = structPins();
  list.forEach((p,idx)=>{
    const pin = document.createElement('div');
    pin.className='pin'; pin.innerText=String(idx+1);
    pin.style.left=p.x+'%'; pin.style.top=p.y+'%';
    const note=document.createElement('div');
    note.className='pinNote'; note.textContent=p.text||'(ë©”ëª¨ ì—†ìŒ)'; note.style.display='none';
    pin.addEventListener('mouseenter', ()=>{ note.style.display='block'; });
    pin.addEventListener('mouseleave', ()=>{ note.style.display='none'; });
    pin.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const v = prompt('í•€ ìˆ˜ì • (ë¹„ìš°ë©´ ì‚­ì œ)', p.text||'');
      if(v===null) return;
      const arr=list.slice();
      if(v.trim()===''){ setStructPins(arr.filter(x=>x.id!==p.id)); }
      else { p.text=v.trim(); setStructPins(arr); }
      renderStructPinLayer();
    });
    const wrap=document.createElement('div');
    wrap.style.position='absolute'; wrap.style.left=p.x+'%'; wrap.style.top=p.y+'%'; wrap.style.transform='translate(-50%,-50%)';
    wrap.appendChild(pin); wrap.appendChild(note);
    layer.appendChild(wrap);
  });
}
$('structPanel').addEventListener('click', (e)=>{
  if(!structPinMode) return;
  if(e.target.closest('.structTools') || e.target.closest('.card') || e.target.closest('#stepTitle') || e.target.closest('#stepBody') || e.target.closest('.slot-tools')) return; 
  
  const rect = $('structPanel').getBoundingClientRect();
  const x = ((e.clientX-rect.left)/rect.width)*100;
  const y = ((e.clientY-rect.top)/rect.height)*100;
  const text = prompt('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:');
  if(text===null) return;
  const list = structPins();
  list.push({id:uuid(), x:+x.toFixed(2), y:+y.toFixed(2), text:text.trim()});
  setStructPins(list); renderStructPinLayer();
  
  // âœ¨ UX ê°œì„ : í•€ ì¶”ê°€ í›„ ëª¨ë“œ ìë™ í•´ì œ
  structPinMode = false;
  $('structPinMode').checked = false;
});
/* Live: Iframe + Images */
function getSrc(){ return localStorage.getItem(STORAGE.SRC) || ''; }
function setSrc(v){
  localStorage.setItem(STORAGE.SRC, v);
  $('srcStatus').innerText='í˜„ì¬: '+(v||'ì—°ê²°ë˜ì§€ ì•ŠìŒ');
  if(v){ 
    $('liveFrame').src=v; 
    localStorage.setItem(STORAGE.MODE, 'iframe'); 
  }
}
$('applySrc').onclick=()=>{ const v=$('srcText').value.trim(); if(v) setSrc(v); updateLiveMode(localStorage.getItem(STORAGE.MODE)); }; 
$('srcFile').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; setSrc(URL.createObjectURL(f)); updateLiveMode('iframe'); }); 

function liveHashForStep(flowKey, stepIdx){
  const f=flows.find(x=>x.key===flowKey); const key=f.map[stepIdx];
  const map={ home:'#home', shop:'#shop', product:'#shop', checkout:'#shop', done:'#mypage',
              apply:'#home', klgc:'#classes', upload:'#shop', publish:'#shop',
              classes:'#classes', detail:'#classes', enroll:'#classes', play:'#classes',
              create:'#classes', sell:'#shop', legacy:'#mypage',
              community:'#community', board:'#community', credit:'#mypage', next:'#home' };
  return map[key] || '#home';
}
function navIframe(){
  const hash = liveHashForStep(activeFlow().key, currentStep);
  try{ $('liveFrame').contentWindow.location.hash=hash; }catch(e){}
}
/* ì´ë¯¸ì§€ ë§¤í•‘ (Storage URL ì‚¬ìš©) */
function imgForStep(flowKey, stepIdx){
  return imgSrc?.[flowKey]?.stepMap?.[stepIdx] || '';
}

// V9.0: ì´ë¯¸ì§€ë¥¼ Firebase Storageì— ì—…ë¡œë“œí•˜ê³  URLì„ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
async function uploadAndAssignImages(files, start){
    const flowKey = activeFlow().key;
    if(!imgSrc[flowKey]) imgSrc[flowKey] = { stepMap: {}, gallery: [] };
    const flowData = imgSrc[flowKey];

    const loadingOverlay = $('loadingOverlay');
    const progressBar = $('progressBar');
    const progressText = $('progressText');
    const loadingTitle = $('loadingTitle');
    
    loadingOverlay.style.display = 'flex';

    for(let i=0; i<files.length; i++){
        const file = files[i];
        // Storage íŒŒì¼ ê²½ë¡œ: teams/knitverse/flowKey/uuid_filename
        const fileName = `${FIREBASE_DOC_PATH}/${flowKey}/${uuid()}_${file.name}`;
        const storageRef = window.ref(storage, fileName);

        loadingTitle.textContent = `ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘: ${i + 1}/${files.length}`;
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        
        // 1. íŒŒì¼ì„ Base64ë¡œ ì½ê¸°
        const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        // 2. Base64ë¥¼ Storageì— ì—…ë¡œë“œ (ì—…ë¡œë“œ ì¤‘ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸)
        try {
            const uploadTask = window.uploadString(storageRef, base64, 'data_url');
            
            // ì—…ë¡œë“œ ì§„í–‰ë¥  ì¶”ì 
            await new Promise((resolve) => {
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                    }, 
                    (error) => {
                        console.error("Upload error:", error);
                        alert(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${file.name}`);
                        resolve(); // ì˜¤ë¥˜ê°€ ë‚˜ë”ë¼ë„ ë‹¤ìŒ íŒŒì¼ë¡œ ë„˜ì–´ê°€ê¸° ìœ„í•´ resolve
                    }, 
                    () => {
                        resolve(); // ì„±ê³µ ì‹œ resolve
                    }
                );
            });
            
            const url = await window.getDownloadURL(storageRef);
            
            // 3. Firestore ë°ì´í„° ì—…ë°ì´íŠ¸
            flowData.gallery.push(url);
            if(start + i < flowLen()){
                flowData.stepMap[start + i] = url;
            }

        } catch(e) {
            console.error(`Error processing file ${file.name}:`, e);
            alert(`ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: ${file.name}`);
        }
    }

    loadingOverlay.style.display = 'none';

    // ìµœì¢…ì ìœ¼ë¡œ ëª¨ë“  ì´ë¯¸ì§€ URL ë§µì„ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
    window.setDoc(IMAGES_REF, imgSrc, { merge: true })
        .catch(e => console.error("Error saving image map:", e));
        
    localStorage.setItem(STORAGE.MODE, 'images');
    setSrc(''); 
    updateLiveMode('images');
    renderThumbs(); renderImages();
}

// ì¸ë„¤ì¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderThumbs(){
  const flowKey = activeFlow().key;
  if(!imgSrc[flowKey]) imgSrc[flowKey] = { stepMap: {}, gallery: [] };
  const d = imgSrc[flowKey];
  const list=$('imgList'); list.innerHTML='';
  const steps=activeFlow().steps; 
  
  for(let i=0;i<steps.length;i++){
    const url=imgForStep(flowKey, i);
    const el=document.createElement('div');
    el.className='thumb'+(i===currentStep?' active':''); el.setAttribute('draggable','true'); el.dataset.step=i;
    // V9.0: ì¸ë„¤ì¼ ì‚­ì œ ì‹œ Storageì—ì„œë„ ì´ë¯¸ì§€ íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤.
    const deleteBtn = url ? `<button class="del">x</button>` : '';

    el.innerHTML = deleteBtn +
                   (url?`<img src="${url}">`:'') +
                   `<div class="cap">Step ${i+1}<br>${steps[i].title}${url?'':'<br>(ë¹„ì–´ ìˆìŒ)'}</div>`;
    
    el.querySelector('.del')?.addEventListener('click', async ev=>{ 
        ev.stopPropagation(); 
        const urlToDelete = d.stepMap[i];
        if(!confirm(`ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? Storageì—ì„œë„ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

        // 1. Storageì—ì„œ íŒŒì¼ ì‚­ì œ
        try {
            const fileRef = window.ref(storage, urlToDelete);
            await window.deleteObject(fileRef);
        } catch (e) {
            console.warn("Storage deletion failed (file might not exist or permission error):", e);
        }

        // 2. Firestore map ì—…ë°ì´íŠ¸ ë° ì €ì¥
        delete d.stepMap[i]; 
        // ê°¤ëŸ¬ë¦¬ì—ì„œë„ í•´ë‹¹ URL ì œê±°
        d.gallery = d.gallery.filter(itemUrl => itemUrl !== urlToDelete);

        await window.setDoc(IMAGES_REF, imgSrc, { merge: true });
        // ë¦¬ìŠ¤ë„ˆê°€ ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬í•  ê²ƒì…ë‹ˆë‹¤. (renderThumbs í˜¸ì¶œ í•„ìš” ì—†ìŒ)
        saveState(); 
    }); 
    el.addEventListener('click', (e)=>{ 
      if(e.target.classList.contains('del')) return;
      currentStep = i; 
      renderAll(); 
      saveState();
    });
    // ì¸ë„¤ì¼ ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìˆœì„œ ë³€ê²½)
    el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', i.toString()); el.classList.add('dragging'); });
    el.addEventListener('dragend',   ev=>{ el.classList.remove('dragging'); });
    el.addEventListener('dragover',  ev=>{ ev.preventDefault(); el.classList.add('drag-over'); });
    el.addEventListener('dragleave', ev=>{ el.classList.remove('drag-over'); });
    el.addEventListener('drop',      ev=>{
      ev.preventDefault(); el.classList.remove('drag-over');
      const from=parseInt(ev.dataTransfer.getData('text/plain'),10), to=i;
      const a=d.stepMap[from], b=d.stepMap[to];
      if(a===undefined && b===undefined) return;
      d.stepMap[from]=b; d.stepMap[to]=a; 
      window.setDoc(IMAGES_REF, imgSrc, { merge: true });
      renderThumbs(); renderImages(); saveState(); 
    });
    list.appendChild(el);
  }
  const mappedCount = steps.filter((s, i) => d.stepMap[i]).length;
  $('imgInfo').innerText = `ë§¤í•‘ë¨: ${mappedCount}/${steps.length} ë‹¨ê³„`;
}
$('btnPickImages').onclick=()=>$('imgFiles').click();
$('imgFiles').addEventListener('change', async e=>{
  const files=Array.from(e.target.files||[]); if(!files.length) return;
  await uploadAndAssignImages(files, currentStep);
});
$('btnAssignFromCurrent').onclick=async ()=>{
  const flowKey = activeFlow().key;
  if(!imgSrc[flowKey] || !imgSrc[flowKey].gallery || imgSrc[flowKey].gallery.length === 0){ 
      alert('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; 
  }
  
  // ë§µí•‘ ì´ˆê¸°í™” ë° ìƒˆë¡œ ë§µí•‘
  imgSrc[flowKey].stepMap={}; 
  let s=currentStep; 
  imgSrc[flowKey].gallery.forEach(u=>{ 
      if(s < flowLen()){ 
          imgSrc[flowKey].stepMap[s] = u; s++; 
      } 
  });
  
  await window.setDoc(IMAGES_REF, imgSrc, { merge: true });

  localStorage.setItem(STORAGE.MODE, 'images');
  setSrc('');
  updateLiveMode('images'); 
  renderThumbs(); renderImages();
  saveState();
};
$('btnClearMap').onclick=()=>{ 
    const flowKey = activeFlow().key;
    if(!imgSrc[flowKey]){
        alert('ë§¤í•‘í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    if(!confirm('ì´ í”Œë¡œìš°ì˜ ëª¨ë“  ì´ë¯¸ì§€ ë§¤í•‘ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ì†Œ íŒŒì¼ì€ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

    imgSrc[flowKey].stepMap = {}; 
    window.setDoc(IMAGES_REF, imgSrc, { merge: true });
    
    renderThumbs(); renderImages(); saveState(); 
}; 

/* ì´ë¯¸ì§€ í•€ (Live ì´ë¯¸ì§€ ì°½ ê¸°ëŠ¥) */
function getPins(flowKey=activeFlow().key, step=currentStep){
  if(!pins[flowKey]) pins[flowKey]={}; 
  if(!pins[flowKey][step]) pins[flowKey][step]=[]; 
  return pins[flowKey][step];
}
function savePins(list, flowKey=activeFlow().key, step=currentStep){
  if(!pins[flowKey]) pins[flowKey]={}; 
  pins[flowKey][step]=list;

  window.setDoc(PINS_REF, pins, { merge: true })
    .catch(e => console.error("Error saving pins:", e));
  saveState();
}
let pinMode=false;
$('pinMode').addEventListener('change', e=>{ 
    pinMode = e.target.checked; 
});
$('btnClearPins').addEventListener('click', ()=>{ savePins([]); renderPins(); });

$('imgBoard').addEventListener('click', (e)=>{
  if(!pinMode) return;
  if(!imgForStep(activeFlow().key, currentStep)){ alert('ì´ ë‹¨ê³„ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const rect=$('imgBoard').getBoundingClientRect();
  const x=((e.clientX-rect.left)/rect.width)*100, y=((e.clientY-rect.top)/rect.height)*100;
  const text=prompt('í•€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:'); if(text===null) return;
  const list=getPins(); list.push({id:uuid(), x:+x.toFixed(2), y:+y.toFixed(2), text:text.trim()});
  savePins(list); renderPins();

  // âœ¨ UX ê°œì„ : í•€ ì¶”ê°€ í›„ ëª¨ë“œ ìë™ í•´ì œ
  pinMode = false;
  $('pinMode').checked = false;
});

function renderPins(){
  renderPinLayer('pinLayer', getPins());
}
function renderPinLayer(layerId, list){
  const layer=$(layerId); if(!layer) return; layer.innerHTML='';
  list.forEach((p,idx)=>{
    const pin=document.createElement('div');
    pin.className='pin'; pin.innerText=String(idx+1);
    pin.style.left=p.x+'%'; pin.style.top=p.y+'%';
    const note=document.createElement('div'); note.className='pinNote'; note.textContent=p.text||'(ì„¤ëª… ì—†ìŒ)'; note.style.display='none';
    pin.addEventListener('mouseenter', ()=>{ note.style.display='block'; });
    pin.addEventListener('mouseleave', ()=>{ note.style.display='none'; });
    pin.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const v=prompt('í•€ ìˆ˜ì • (ë¹„ìš°ë©´ ì‚­ì œ)', p.text||''); if(v===null) return;
      const arr=list.slice();
      if(v.trim()===''){ savePins(arr.filter(x=>x.id!==p.id)); } else { p.text=v.trim(); savePins(arr); }
      renderPins();
    });
    const wrap=document.createElement('div'); wrap.style.position='absolute'; wrap.style.left=p.x+'%'; wrap.style.top=p.y+'%'; wrap.style.transform='translate(-50%,-50%)';
    wrap.appendChild(pin); wrap.appendChild(note); layer.appendChild(wrap);
  });
}
function renderImages(){
  const url = imgForStep(activeFlow().key, currentStep) || '';
  const img = $('stepImg'); 
  if(img) {
    img.src=url;
    img.alt = url ? activeStepData().title : "Step image (No image assigned)";
  }
  if(localStorage.getItem(STORAGE.MODE) === 'images') {
    renderPins();
  }
}
/* ì´ë¯¸ì§€ ìº¡ì²˜ ê¸°ëŠ¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
$('btnExportImage').addEventListener('click', ()=>{
    const target = $('mainContent');
    
    const originalText = $('btnExportImage').textContent;
    $('btnExportImage').textContent = 'ìº¡ì²˜ ì¤‘...';
    $('btnExportImage').disabled = true;

    html2canvas(target, {
        allowTaint: true,
        useCORS: true,
        scrollY: -window.scrollY, 
        scale: 2 
    }).then(canvas => {
        const title = activeFlow().title.replace(/[^a-z0-9]/gi, '_');
        const stepName = activeStepData().title.replace(/[^a-z0-9]/gi, '_');
        const filename = `${title}_${stepName}_${new Date().getTime()}.png`;
        
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = filename;
        link.click();

        $('btnExportImage').textContent = originalText;
        $('btnExportImage').disabled = false;
        alert('í™”ë©´ ìº¡ì²˜(PNG)ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }).catch(err => {
        console.error("ìº¡ì²˜ ì‹¤íŒ¨:", err);
        $('btnExportImage').textContent = originalText;
        $('btnExportImage').disabled = false;
        alert('ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” ë¡œê·¸ í™•ì¸)');
    });
});
// V9.0: JSON Export/Import ê¸°ëŠ¥ì€ Firebase ì—°ë™ìœ¼ë¡œ ì¸í•´ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ë¡œì§ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.

/* ê¸°íƒ€ í¸ì§‘ ê¸°ëŠ¥ (ì¬ì¸ë±ì‹± ë¡œì§ ë“±ì€ ìœ ì§€) */
// V9.0: ì´ë¯¸ì§€ ê´€ë ¨ ë°ì´í„°ëŠ” Firebase ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬í•˜ë¯€ë¡œ, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ shift ë¡œì§ì„ ì œê±°í•˜ê³  saveFlowsë§Œ í˜¸ì¶œí•©ë‹ˆë‹¤.
function shiftAfterDelete(flowKey, delIdx){
    // Firestore ë¦¬ìŠ¤ë„ˆê°€ ë°ì´í„° êµ¬ì¡° ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ì²˜ë¦¬í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” flows ë°ì´í„°ë§Œ ë³€ê²½í•˜ê³  saveFlowsë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
}
function shiftAfterInsert(flowKey, insIdx){
    // Firestore ë¦¬ìŠ¤ë„ˆê°€ ë°ì´í„° êµ¬ì¡° ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ì²˜ë¦¬í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” flows ë°ì´í„°ë§Œ ë³€ê²½í•˜ê³  saveFlowsë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
}

// ë‹¨ê³„ ë°ì´í„° ë³µì œ (ì´ë¯¸ì§€, í•€, êµ¬ì¡° í•€)
function cloneStepData(flowKey, fromIdx, toIdx) {
    // 1. Image Map Clone
    if (imgSrc?.[flowKey]?.stepMap?.[fromIdx]) {
        if(!imgSrc[flowKey].stepMap) imgSrc[flowKey].stepMap = {};
        imgSrc[flowKey].stepMap[toIdx] = imgSrc[flowKey].stepMap[fromIdx];
        window.setDoc(IMAGES_REF, imgSrc, { merge: true });
    }
    // 2. Pins Clone
    if (pins?.[flowKey]?.[fromIdx]) {
        if(!pins[flowKey]) pins[flowKey] = {};
        pins[flowKey][toIdx] = JSON.parse(JSON.stringify(pins[flowKey][fromIdx]));
        window.setDoc(PINS_REF, pins, { merge: true });
    }
    // 3. Structure Pins Clone
    if (structPinsData?.[flowKey]?.[fromIdx]) {
        if(!structPinsData[flowKey]) structPinsData[flowKey] = {};
        structPinsData[flowKey][toIdx] = JSON.parse(JSON.stringify(structPinsData[flowKey][fromIdx]));
        window.setDoc(SPINS_REF, structPinsData, { merge: true });
    }
}


/* ì†ŒìŠ¤ ì „í™˜ (ëª¨ë“œ ì¶©ëŒ ë°©ì§€ ë° ë‹¨ì¼í™”) */
function updateLiveMode(mode){
    const flowKey = activeFlow()?.key;
    const isImageModePreferred = (flowKey && Object.keys(imgSrc[flowKey]?.stepMap || {}).length > 0) || (localStorage.getItem(STORAGE.MODE) === 'images');
    const isIframeSourceLoaded = getSrc() && localStorage.getItem(STORAGE.MODE) === 'iframe';

    if (isImageModePreferred && !isIframeSourceLoaded) {
        localStorage.setItem(STORAGE.MODE, 'images');
        $('iframePane').style.display = 'none';
        $('imagesPane').style.display = 'block';
        renderImages(); 
    } else if (isIframeSourceLoaded) {
        localStorage.setItem(STORAGE.MODE, 'iframe');
        $('iframePane').style.display = 'block';
        $('imagesPane').style.display = 'none';
        navIframe();
    } else {
        localStorage.setItem(STORAGE.MODE, 'images');
        $('iframePane').style.display = 'none';
        $('imagesPane').style.display = 'block';
        renderImages();
    }
}

/* Flow ë¦¬ìŠ¤íŠ¸ + DnD */
function buildFlowList(){
  const list=$('flowList'); list.innerHTML='';
  flows.forEach((f,idx)=>{
    const el=document.createElement('div');
    el.className='flow'+(idx===currentFlowIdx?' active':''); el.draggable=true; el.dataset.idx=idx;
    el.innerHTML=`<div><strong>${f.title}</strong></div><div class="meta">${f.steps.length} ë‹¨ê³„</div><div class="reord">â†•</div>`;
    el.addEventListener('click', (e)=>{ if(e.target.classList.contains('reord')) return; selectFlow(idx); });
    el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', idx.toString()); el.classList.add('dragging'); });
    el.addEventListener('dragend',   ev=>{ el.classList.remove('dragging'); });
    el.addEventListener('dragover',  ev=>{ ev.preventDefault(); el.classList.add('drag-over'); });
    el.addEventListener('dragleave', ev=>{ el.classList.remove('drag-over'); });
    el.addEventListener('drop',      ev=>{
      ev.preventDefault(); el.classList.remove('drag-over');
      const from=parseInt(ev.dataTransfer.getData('text/plain'),10), to=idx;
      if(from===to) return;
      const item=flows.splice(from,1)[0]; flows.splice(to,0,item);
      
      if(currentFlowIdx === from) currentFlowIdx = to;
      else if(currentFlowIdx > from && currentFlowIdx <= to) currentFlowIdx--;
      else if(currentFlowIdx < from && currentFlowIdx >= to) currentFlowIdx++;
      
      saveFlows(flows); // Firebase ì €ì¥
      buildFlowList();
      renderAll();
      saveState();
    });
    list.appendChild(el);
  });
}
function selectFlow(idx){
  currentFlowIdx = idx; currentStep=0;
  document.querySelectorAll('.flow').forEach((x,i)=>x.classList.toggle('active', i===idx));
  renderAll();
  updateLiveMode(localStorage.getItem(STORAGE.MODE) || 'images');
  saveState();
}

/* í”Œë¡œìš° í¸ì§‘: ì¶”ê°€/ì´ë¦„ë³€ê²½/ì‚­ì œ */
const DEFAULT_STEP_COUNT = 5; 

$('btnAddFlow').addEventListener('click', ()=>{
    const title = (prompt(`ìƒˆë¡œìš´ í”Œë¡œìš° ì´ë¦„? (ê¸°ë³¸ ${DEFAULT_STEP_COUNT}ë‹¨ê³„ ìƒì„±)`)||'').trim();
    if(!title) return;
    
    const defaultSteps = [];
    const defaultMap = [];
    for(let i=1; i<=DEFAULT_STEP_COUNT; i++){
        defaultSteps.push({
            title: `Step ${i}`,
            body: `ìƒˆë¡œ ì¶”ê°€ëœ í”Œë¡œìš°ì˜ ${i}ë²ˆì§¸ ë‹¨ê³„ì…ë‹ˆë‹¤.`,
            slots: [
                {key:'core', name:'í•µì‹¬ ìš”ì†Œ', content: 'í•µì‹¬ ìš”ì†Œ'},
                {key:'link', name:'ì—°ê²°', content: 'ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” íŠ¸ë¦¬ê±°'},
                {key:'metric', name:'ë©”íŠ¸ë¦­', content: 'ì „í™˜/ì´íƒˆ í¬ì¸íŠ¸, GA ì´ë²¤íŠ¸'}
            ]
        });
        defaultMap.push('home'); 
    }

    const newFlow = {
        key: uuid(),
        title: title,
        map: defaultMap,
        steps: defaultSteps
    };
    
    flows.push(newFlow);
    saveFlows(flows); // Firebase ì €ì¥
    currentFlowIdx = flows.length - 1;
    currentStep = 0;
    buildFlowList();
    renderAll();
    saveState();
});

$('btnRenameFlow').addEventListener('click', ()=>{
    const f = activeFlow();
    const next = (prompt('í”Œë¡œìš° ì´ë¦„ ë³€ê²½:', f.title)||'').trim();
    if(!next) return;
    f.title = next;
    saveFlows(flows); // Firebase ì €ì¥
    buildFlowList();
    renderAll();
    saveState();
});

$('btnDeleteFlow').addEventListener('click', ()=>{
    if(flows.length <= 1){ alert('ìµœì†Œ 1ê°œì˜ í”Œë¡œìš°ëŠ” í•„ìš”í•©ë‹ˆë‹¤.'); return; }
    const f = activeFlow();
    if(!confirm(`í”Œë¡œìš° "${f.title}" (ì´ ${f.steps.length} ë‹¨ê³„)ë¥¼ ì •ë§ë¡œ ì‚­ì œí• ê¹Œìš”? ì´ í”Œë¡œìš°ì˜ ëª¨ë“  ì´ë¯¸ì§€ì™€ ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
    
    const flowKeyToDelete = f.key;
    const updateFirebaseDoc = async (docRef, data, flowKey) => {
        if(data[flowKey]) {
            delete data[flowKey];
            await window.setDoc(docRef, data);
        }
    }
    
    // ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œëŠ” ë³µì¡í•˜ë¯€ë¡œ í˜„ì¬ëŠ” Firestore ë°ì´í„°ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.
    // *ì£¼ì˜: Storageì— ì €ì¥ëœ ì´ë¯¸ì§€ íŒŒì¼ ìì²´ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì•¼ í•©ë‹ˆë‹¤.*
    
    // Firestore ë°ì´í„° ì‚­ì œ (pins, structPins, imgSrc)
    updateFirebaseDoc(PINS_REF, pins, flowKeyToDelete);
    updateFirebaseDoc(SPINS_REF, structPinsData, flowKeyToDelete);
    updateFirebaseDoc(IMAGES_REF, imgSrc, flowKeyToDelete);
    

    flows.splice(currentFlowIdx, 1);
    if(currentFlowIdx >= flows.length) currentFlowIdx = flows.length - 1;
    currentStep = 0; 
    
    saveFlows(flows); // Firebase ì €ì¥
    buildFlowList();
    renderAll();
    saveState();
});


/* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ (ì´ì „/ë‹¤ìŒ í´ë¦­ ì‹œ renderAll í˜¸ì¶œ) */
$('btnPrev').addEventListener('click', ()=>{ if(currentStep>0){ currentStep--; renderAll(); saveState(); } });
$('btnNext').addEventListener('click', ()=>{ if(currentStep<flowLen()-1){ currentStep++; renderAll(); saveState(); } });
function renderAll(){
  renderStructure();
  renderThumbs(); 
  updateLiveMode(localStorage.getItem(STORAGE.MODE));
}
/* ë‹¨ê³„ í¸ì§‘: ì¶”ê°€/ë³µì œ/ì´ë¦„ë³€ê²½/ì‚­ì œ */
function addNewStep(){
    const f = activeFlow();
    const title = (prompt('ìƒˆ ë‹¨ê³„ ì´ë¦„?', 'New Step')||'').trim();
    if(!title) return;
    const body  = (prompt('ì„¤ëª…(ì„ íƒ):', '')||'').trim();
    const insertAt = currentStep+1;
    shiftAfterInsert(f.key, insertAt);
    f.steps.splice(insertAt, 0, { 
        title, 
        body: body||'ì„¤ëª… ì—†ìŒ', 
        slots: [
            {key:'core', name:'í•µì‹¬ ìš”ì†Œ', content: 'í•µì‹¬ ìš”ì†Œ'},
            {key:'link', name:'ì—°ê²°', content: 'ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” íŠ¸ë¦¬ê±°'},
            {key:'metric', name:'ë©”íŠ¸ë¦­', content: 'ì „í™˜/ì´íƒˆ í¬ì¸íŠ¸, GA ì´ë²¤íŠ¸'}
        ]
    });
    f.map.splice(insertAt, 0, f.map[currentStep] || 'home');
    saveFlows(flows); // Firebase ì €ì¥
    currentStep = insertAt;
    renderAll(); navIframe(); saveState();
}

function cloneStep() {
    const f = activeFlow();
    const s = activeStepData();
    
    const cloneTitle = (prompt('ë³µì œí•  ë‹¨ê³„ ì´ë¦„?', s.title + ' (ë³µì œ)')||'').trim();
    if(!cloneTitle) return;

    const currentIdx = currentStep;
    const insertAt = currentStep + 1;
    
    shiftAfterInsert(f.key, insertAt);

    const newStep = JSON.parse(JSON.stringify(s));
    newStep.title = cloneTitle;

    f.steps.splice(insertAt, 0, newStep);
    f.map.splice(insertAt, 0, f.map[currentIdx] || 'home'); 
    saveFlows(flows); // Firebase ì €ì¥

    cloneStepData(f.key, currentIdx, insertAt);

    currentStep = insertAt;
    renderAll(); navIframe(); saveState();
}


function renameStep(){
    const f = activeFlow();
    const s = f.steps[currentStep];
    const next = (prompt('ë‹¨ê³„ ì´ë¦„ ë³€ê²½:', s.title)||'').trim();
    if(!next) return;
    s.title = next;
    saveFlows(flows); // Firebase ì €ì¥
    renderAll(); saveState();
}
function deleteStep(){
    const f = activeFlow();
    if(f.steps.length<=1){ alert('ìµœì†Œ 1ë‹¨ê³„ëŠ” í•„ìš”í•©ë‹ˆë‹¤.'); return; }
    if(!confirm(`í˜„ì¬ ë‹¨ê³„ "${f.steps[currentStep].title}" ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
    const delIdx = currentStep;
    shiftAfterDelete(f.key, delIdx);
    f.steps.splice(delIdx,1);
    f.map.splice(delIdx,1);
    if(currentStep>=f.steps.length) currentStep=f.steps.length-1;
    saveFlows(flows); // Firebase ì €ì¥
    renderAll(); navIframe(); saveState();
}

$('btnStepAdd').addEventListener('click', addNewStep);
$('btnStepClone').addEventListener('click', cloneStep); 
$('btnStepRename').addEventListener('click', renameStep);
$('btnStepDelete').addEventListener('click', deleteStep);


/* ì´ˆê¸° ì‹œì‘ */
(function init(){
  initFlows();
  buildFlowList();
  
  const src = getSrc(); 
  if(!localStorage.getItem(STORAGE.MODE)){
      if(src) {
          localStorage.setItem(STORAGE.MODE, 'iframe');
      } else {
          localStorage.setItem(STORAGE.MODE, 'images');
      }
  }
  
  // loadState()ëŠ” Firestore ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬í•˜ë¯€ë¡œ ì‚­ì œ
  if(currentFlowIdx >= flows.length) currentFlowIdx = 0;
  if(currentStep >= flowLen()) currentStep = flowLen() - 1;
  
  selectFlow(currentFlowIdx); 
})();
</script>
</body>
</html>
